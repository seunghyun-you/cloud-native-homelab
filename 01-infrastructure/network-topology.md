# Network Topology

홈랩 환경의 네트워크 설계 및 구성 내용입니다.

## 네트워크 설계 목표

1. **실무 환경 시뮬레이션**: Multi-Subnet 구성으로 실제 데이터센터 환경 재현
2. **네트워크 분리**: 용도별 네트워크 분리 (Management, Storage, Cluster)
3. **라우팅 학습**: Router 노드를 통한 서브넷 간 통신 구현

## 네트워크 구성도

```
                                    ┌─────────────────┐
                                    │   Host Machine  │
                                    │  192.168.0.x    │
                                    └────────┬────────┘
                                             │ NAT (eth0)
                                             │
┌────────────────────────────────────────────┼────────────────────────────────────────────┐
│                                            │                                            │
│  ┌─────────────────────────────────────────┴─────────────────────────────────────────┐  │
│  │                         VirtualBox Internal Network                               │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│  ┌─ Subnet1: 192.168.10.0/24 (K8s Primary) ────────────────────────────────────────┐    │
│  │                                                                                  │    │
│  │   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                      │    │
│  │   │  cilium-ctr  │    │  cilium-w1   │    │  cilium-w2   │                      │    │
│  │   │  .10.100     │    │  .10.101     │    │  .10.102     │                      │    │
│  │   │  (Master)    │    │  (Worker)    │    │  (Worker)    │                      │    │
│  │   └──────────────┘    └──────────────┘    └──────────────┘                      │    │
│  │          │                   │                   │                              │    │
│  └──────────┴───────────────────┴───────────────────┴──────────────────────────────┘    │
│                                         │                                                │
│                                  ┌──────┴──────┐                                        │
│                                  │  cilium-r   │                                        │
│                                  │  (Router)   │                                        │
│                                  │             │                                        │
│                                  │ eth1: .10.200                                        │
│                                  │ eth2: .20.200                                        │
│                                  │             │                                        │
│                                  │ loop1: 10.10.1.200 (Dummy)                           │
│                                  │ loop2: 10.10.2.200 (Dummy)                           │
│                                  └──────┬──────┘                                        │
│                                         │                                                │
│  ┌─ Subnet2: 192.168.20.0/24 (K8s Secondary) ──────────────────────────────────────┐    │
│  │                                      │                                          │    │
│  │                               ┌──────┴───────┐                                  │    │
│  │                               │  cilium-w3   │                                  │    │
│  │                               │  .20.100     │                                  │    │
│  │                               │  (Worker)    │                                  │    │
│  │                               └──────────────┘                                  │    │
│  │                                                                                  │    │
│  └──────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                          │
│  ┌─ Storage Network: 192.168.50.0/24 (Public) + 192.168.60.0/24 (Cluster) ─────────┐    │
│  │                                                                                  │    │
│  │   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                      │    │
│  │   │   ceph-01    │    │   ceph-02    │    │   ceph-03    │                      │    │
│  │   │  .50.201     │    │  .50.202     │    │  .50.203     │   Public             │    │
│  │   │  .60.201     │    │  .60.202     │    │  .60.203     │   Cluster            │    │
│  │   └──────────────┘    └──────────────┘    └──────────────┘                      │    │
│  │                                                                                  │    │
│  └──────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                          │
└──────────────────────────────────────────────────────────────────────────────────────────┘
```

## 서브넷 상세

### Kubernetes 네트워크

| 네트워크 | CIDR | 용도 | 노드 |
|----------|------|------|------|
| Subnet1 | 192.168.10.0/24 | K8s Primary | ctr, w1, w2, router |
| Subnet2 | 192.168.20.0/24 | K8s Secondary | w3, router |
| Pod CIDR | 172.20.0.0/16 | Cilium Pod Network | All K8s nodes |
| Service CIDR | 10.96.0.0/16 | K8s Service | All K8s nodes |

### Ceph Storage 네트워크

| 네트워크 | CIDR | 용도 |
|----------|------|------|
| Public | 192.168.50.0/24 | 클라이언트 → OSD 접근 |
| Cluster | 192.168.60.0/24 | OSD 간 복제/복구 트래픽 |

### 가상 네트워크 (Router)

| 인터페이스 | IP | 용도 |
|------------|----|----- |
| loop1 | 10.10.1.200/24 | Dummy interface (테스트용) |
| loop2 | 10.10.2.200/24 | Dummy interface (테스트용) |

## 라우팅 구성

### Router 노드 (cilium-r)

```bash
# IP Forwarding 활성화
net.ipv4.ip_forward = 1
```

Router 노드는 두 서브넷을 연결하며, 각 서브넷의 노드들은 Router를 통해 통신합니다.

### Subnet1 노드 라우팅 테이블

```bash
# net-setting-01.sh 적용 결과
ip route show

192.168.20.0/24 via 192.168.10.200  # Subnet2 → Router 경유
172.20.0.0/16   via 192.168.10.200  # Pod CIDR → Router 경유
10.10.0.0/16    via 192.168.10.200  # Dummy Network → Router 경유
```

### Subnet2 노드 라우팅 테이블

```bash
# net-setting-02.sh 적용 결과
ip route show

192.168.10.0/24 via 192.168.20.200  # Subnet1 → Router 경유
172.20.0.0/16   via 192.168.20.200  # Pod CIDR → Router 경유
10.10.0.0/16    via 192.168.20.200  # Dummy Network → Router 경유
```

## Cilium 네트워크 모드

### Native Routing (Direct Routing)

```yaml
# Cilium Helm Values
routingMode: native
autoDirectNodeRoutes: true
ipv4NativeRoutingCIDR: 172.20.0.0/16
kubeProxyReplacement: true
bpf.masquerade: true
```

**선택 이유:**
- kube-proxy 제거로 eBPF 기반 고성능 네트워킹
- VXLAN 오버헤드 없는 직접 라우팅
- 노드 간 Pod 통신 시 NAT 없이 직접 통신

### 트래픽 흐름 예시

```
Pod A (cilium-w1)                    Pod B (cilium-w3)
172.20.10.5                          172.20.30.8
     │                                    ▲
     │ src: 172.20.10.5                   │
     │ dst: 172.20.30.8                   │
     ▼                                    │
┌─────────┐    ┌─────────┐    ┌─────────┐
│cilium-w1│───▶│cilium-r │───▶│cilium-w3│
│.10.101  │    │.10.200  │    │.20.100  │
└─────────┘    │.20.200  │    └─────────┘
               └─────────┘
               (Router)
```

## 포트 포워딩 (SSH 접근)

호스트에서 각 VM에 SSH 접근을 위한 포트 매핑:

| VM | Guest Port | Host Port | 접근 명령 |
|----|------------|-----------|-----------|
| cilium-ctr | 22 | 60000 | `ssh -p 60000 vagrant@localhost` |
| cilium-w1 | 22 | 60001 | `ssh -p 60001 vagrant@localhost` |
| cilium-w2 | 22 | 60002 | `ssh -p 60002 vagrant@localhost` |
| cilium-r | 22 | 60009 | `ssh -p 60009 vagrant@localhost` |
| cilium-w3 | 22 | 60010 | `ssh -p 60010 vagrant@localhost` |
| ceph-01 | 22 | 50001 | `ssh -p 50001 vagrant@localhost` |
| ceph-02 | 22 | 50002 | `ssh -p 50002 vagrant@localhost` |
| ceph-03 | 22 | 50003 | `ssh -p 50003 vagrant@localhost` |

## 서비스 노출 포트

| 서비스 | NodePort | 접근 URL |
|--------|----------|----------|
| Prometheus | 30001 | http://192.168.10.100:30001 |
| Grafana | 30002 | http://192.168.10.100:30002 |
| Hubble UI | 30003 | http://192.168.10.100:30003 |
